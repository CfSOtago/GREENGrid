---
title: 'GREEN Grid Heat Pump Profiles'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  html_document:
    code_folding: hide
    fig_caption: true
    keep_md: true
    number_sections: true
    self_contained: no
    toc: true
    toc_float: true
    toc_depth: 2
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```

```{r codeSetup, include=FALSE}
# Housekeeping ----
rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

# Local parameters ----
fullFb <- 0 # switch on (1) or off (0) full feedback
baTest <- 1 # test (1) or full (0) run?

b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576

gsMasterFile <- path.expand("~/Syncplicity Folders/Green Grid Project Management Folder/Gridspy/Master list of Gridspy units.xlsx")

if(baTest == 1){
  # Local test
  dPath <- path.expand("~/Data/NZGreenGrid/gridspy/") # BA laptop test set
  fpath <- paste0(dPath,"1min_orig/") # location of data
  outPath <- paste0(dPath, "consolidated/1min/") # place to save them 
} else {
  # full monty
  dPath <- "/Volumes/hum-csafe/Research Projects/GREEN Grid/" # HPS
  fpath <- paste0(dPath,"_RAW DATA/GridSpyData/") # location of data
  outPath <- paste0(dPath, "Clean_data/safe/gridSpy/1min/") # place to save them 
}

# Load nzGREENGrid package ----
library(nzGREENGrid) # local utilities

# Packages needed in this .Rmd file ----
rmdLibs <- c("ggplot2", # for fancy graphs
             "knitr", # for kable
             "kableExtra" # for extra kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# Local functions ----


```

\newpage

# Status

```{r reportStatus, include = FALSE}
if(baTest){
  msg <- paste0("Test run using reduced data from ", fpath)
} else {
  msg <- paste0("Full run using all data from ", fpath)
}
```

`r msg`

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) GREEN Grid Heat Pump Profiles, University of Otago: Dunedin, NZ.

\newpage

# Introduction

Report circulation:

 * Restricted to: [NZ GREEN Grid](https://www.otago.ac.nz/centre-sustainability/research/energy/otago050285.html) project partners and contractors.

## Purpose

This report is intended to: 

 * load and clean the project electricity power data (Grid Spy)
 * select the Heat Pump circuits (via their labels)
 * build exploratory demand profiles


## Requirements:

 * cleaned and safe grid spy 1 minute data processed via https://git.soton.ac.uk/ba1e12/nzGREENGrid/blob/master/dataProcessing/processNZGGElecCons1minData.Rmd

## History

Generally tracked via our git.soton [repo](https://git.soton.ac.uk/ba1e12/nzGREENGrid):

 * [history](https://git.soton.ac.uk/ba1e12/nzGREENGrid/commits/master)
 * [issues](https://git.soton.ac.uk/ba1e12/nzGREENGrid/issues)
 
## Support

This work was supported by:

 * The [University of Otago](https://www.otago.ac.nz/)
 * The New Zealand [Ministry of Business, Innovation and Employment (MBIE)](http://www.mbie.govt.nz/)
 * [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/) - a [Marie Skłodowska-Curie Global Fellowship](http://ec.europa.eu/research/mariecurieactions/about-msca/actions/if/index_en.htm) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton's Sustainable Energy Research Group (2019-202).
 
This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

We do not 'support' the code but if you have a problem check the [issues](https://git.soton.ac.uk/ba1e12/nzGREENGrid/issues) on our [repo](https://git.soton.ac.uk/ba1e12/nzGREENGrid) and if it doesn't already exist, open one. We might be able to fix it :-)


# Load data files

## Grid Spy metadata

In this section we load metadata from `r gsMasterFile` to link to the power data.

```{r load dmetadata}

unisonDT <- data.table::as.data.table(readxl::read_xlsx(gsMasterFile, sheet = "Unison"))

# keep safe data only
unisonDT <- unisonDT[, .(sample = `Power company`, hhID = `Tag`, 
                         Adults,Teenagers,Children,removed )]
head(unisonDT)

powercoDT <- data.table::as.data.table(readxl::read_xlsx(gsMasterFile, sheet = "Powerco"))
powercoDT <- powercoDT[, .(sample = `Power Co`, hhID = `Building Tag`, 
                           Adults = `Adult`,Teenagers,Children, removed = `date disconnected` )]
head(powercoDT)

# remove NA on rbind
metaDT <- rbind(unisonDT, powercoDT[!is.na(hhID)])
setkey(metaDT, hhID)

kable(caption = "Meta data for sample", metaDT)
```

## Grid Spy data

In this section we load the cleaned data files from `r paste0(outPath,"data/")`.
 
The following table shows the number of files per household that we willl load.

```{r loadFiles}
# check files to load
fpath <- paste0(outPath,"data/")
pattern <- "*.gz"
fListCompleteDT <- nzGREENGrid::getFileList(fpath, pattern)

nFiles <- nrow(fListCompleteDT)
print(paste0("Found ", tidyNum(nFiles), " files"))

filesToLoad <- 
  
t <- fListCompleteDT[dateColName %like% "do not load", .(nFiles = .N,
                       meanSize = mean(fSize),
                       minFileDate = min(fMDate),
                       maxFileDate = max(fMDate)), keyby = .(hhID)]

knitr::kable(caption = "Summary of household files to load", t)
```


```{r loadValidFiles, echo=TRUE, include=FALSE}
# do not include outputs as it breaks the pdf render (why?)
# load and save data using external R script
source("../scripts/process1minGridSpyData.R")

# add metadata
setkey(fListCompleteDT, hhID)
setkey(metaDT, hhID)
fListCompleteDT <- metaDT[fListCompleteDT]
```

# Data quality analysis

Now produce some data quality plots & tables.

## Circuit label checks

The following table shows the number of data files with different circuit labels by household. In theory there should only be one unique list per household and it should be present in every data file. If this is not the case then this implies that:

 * some of the circuit labels for these households may have been changed during the data collection process;
 * some of the circuit labels may have character conversion errors which have changed the labels during the data collection process;
 * at least one file from one household has been saved to a folder containing data from a different household (unfortunately the raw data files do _not_ contain household IDs in the data or the file names which would enable checking/preventative filtering). This will be visible in the table if two households appear to share _exactly_ the same list of circuit labels.

Some or all of these may be true at any given time!

> NB: This table is only legible in the html version of this report because latex does a very bad job of wrapping table cell text. A version is saved in `r paste0(outPath, "circuitLabelCheck.csv")` for viewing in e.g. xl.

```{r circuitLabelCheck}
# short cut if exists already
#ifile <- paste0(outPath, fListFinal)
#fListCompleteDT <- fread(ifile)



# table
t <- table(fListCompleteDT$circuitLabels,fListCompleteDT$hhID)
knitr::kable(caption = "Circuit labels list by household", t)

ofile <- paste0(outPath, "circuitLabelCheckTable.csv")
write.csv(t, ofile)
```

Errors are easy to spot in the following plot where a hhID spans 2 or more circuit labels.

```{r plotCircuitLabelIssuesAsTile, fig.height=8}
dt <- fListCompleteDT[!is.na(circuitLabels), 
                     .(nFiles = .N,
                       minObsDate = min(obsStartDate), # helps locate issues in data
                       maxObsDate = max(obsEndDate),
                       minFileDate = min(fMDate), # helps locate issues in files
                       maxFileDate = max(fMDate),
                       nObs = sum(nObs)),
                     keyby = .(circuitLabels, hhID, sample)] # ignore NA - it is files not loaded due to size thresholds

ggplot2::ggplot(dt, aes(y = hhID, x = circuitLabels, 
                       fill = nObs)) +
  geom_tile() +
  facet_grid(sample ~ .) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) + 
  labs(title = "Circuit label counts for all loaded grid spy data",
       caption = paste0(myCaption,
                        "\nOnly files of size > ", 
                        dataThreshold, " bytes loaded")
       
  )
ggplot2::ggsave(paste0(outPath, "gridSpyLoadedFileCircuitLabelsPlot.png"))
```

The following table provides more detail to aid error checking. Check for:

 * 2+ adjacent rows which have exactly the same circuit labels but different hh_ids. This implies some data from one household has been saved in the wrong folder;
 * 2+ adjacent rows which have different circuit labels but identical hh_ids. This could imply the same thing but is more likely to be errors/changes to the circuit labelling. 
 
If the above plot and this table flag a lot of errors then some re-naming of the circuit labels (column names) may be necessary. 

> NB: As before, the table is only legible in the html version of this report because latex does a very bad job of wrapping table cell text. A version is saved in `r paste0(outPath, "circuitLabelMetaDataCheckTable.csv")` for viewing in e.g. xl.

```{r circuitLabelMetaDataCheck}
knitr::kable(dt, 
             caption = "Circuit labels by household with addiitonal meta-data")

ofile <- paste0(outPath, "circuitLabelMetaDataCheckTable.csv")
write.csv(dt, ofile)
```

Things to note:

 * rf_25 has an aditional unexpected "Incomer 1 - Uncontrolled$2757" circuit in some files but it's value is always NA so we have not 'corrected' this.
 
## Observations

The following plots show the number of observations per day per household. In theory we should not see:

 * dates before 2014 or in to the future. These may indicate:
    * date conversion errors;
 * more than 1440 observations per day. These may indicate:
    * duplicate time stamps - i.e. they have the same time stamps but different power (W) values or different circuit labels;
    * observations from files that are in the 'wrong' rf_XX folder and so are included in the 'wrong' household as 'duplicate' time stamps.

If present both of the latter may have been implied by the table above and would have evaded the de-duplication filter which simply checks each complete row against all others within it's consolidated household dataset (a _within household absolute duplicate_ check).

```{r loadedFilesObsPlots}
# short cut if already generated
# hhStatDT <- as.data.table(read_csv(ofile)) # parses dates
# hhStatDT <- fread("/Volumes/hum-csafe/Research Projects/GREEN Grid/Clean_data/safe/gridSpy/1min/hhDailyObservationsStats.csv")

# add metadata
setkey(hhStatDT, hhID)
setkey(metaDT, hhID)
hhStatMergedDT <- hhStatDT[metaDT]

# tile plot ----
myPlot <- ggplot2::ggplot(hhStatMergedDT, aes( x = as.Date(date), y = hhID, 
                               fill = nObs)) +
  geom_tile() +
  scale_fill_gradient(low = "red", high = "green") +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   hjust = 0.5)) + 
  labs(title = "N observations per household per day for all loaded grid spy data",
       caption = paste0(myCaption,
                        "\nOnly files of size > ", 
                        dataThreshold, " bytes loaded")
       
  )
myPlot #+ facet_grid(. ~ sample)
ggplot2::ggsave(paste0(outPath, "gridSpyLoadedFileNobsTilePlot.png"))
```

```{r plot n obs per hh id as dots}
# point plot ----
myPlot <- ggplot2::ggplot(hhStatMergedDT, aes( x = as.Date(date), 
                               y = nObs, 
                               colour = hhID)) +
  geom_point() +
  #facet_wrap(sample ~ .) +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(title = "N observations per household per day for all loaded grid spy data",
       caption = paste0(myCaption,
                        "\nOnly files of size > ", 
                        dataThreshold, " bytes loaded")
       
  )
myPlot + facet_grid(sample ~ .)
ggplot2::ggsave(paste0(outPath, "gridSpyLoadedFileNobsPointPlot.png"))
```

The following table shows the min/max observations per day and min/max dates for each household. As above, we should not see:

 * dates before 2014 or in to the future (indicates date conversion errors)
 * more than 1440 observations per day (indicates potentially duplicate observations)
 * non-integer counts of circuits as it suggests some column errors
 
 We should also not see NA in any row (indicates date conversion errors). 
 
 If we do see any of these then we still have data cleaning work to do!

```{r summaryTable}
# Stats table (so we can pick out the dateTime errors)
dt <- hhStatMergedDT[, .(minObs = min(nObs),
             maxObs = max(nObs), # should not be more than 1440, if so suggests duplicates
             meanNDataColumns =mean(nDataColumns), #i.e. n circuits
             minDate = min(date),
             maxDate = max(date)),
         keyby = .(hhID, sample)]

knitr::kable(caption = "Summary observation stats by hhID (sorted by date last heard from)", dt[order(maxDate)])
ofile <- paste0(outPath, "householdLiveCheckTable.csv")
write.csv(dt[order(maxDate)], ofile)
```


Finally we show the total number of households which we think are still sending data.

```{r liveDataHouseholds}
plotDT <- hhStatMergedDT[, .(nHH = uniqueN(hhID)), keyby = .(date, sample)]

# point plot ----
myPlot <- ggplot2::ggplot(plotDT, aes( x = as.Date(date), y = nHH, fill = sample)) +
  geom_col() +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(title = "N live households per day for all loaded grid spy data",
       caption = paste0(myCaption,
                        "\nOnly files of size > ", 
                        dataThreshold, " bytes loaded")
       
  )
myPlot
ggplot2::ggsave(paste0(outPath, "gridSpyLiveHouseholdsToDate.png"))

```

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * dplyr - for select and contains [@dplyr]
 * progress - for progress bars [@progress]
 * knitr - to create this document & neat tables [@knitr]
 * kableExtra - for extra neat tables [@kableExtra]
 * nzGREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
