---
title: 'GREEN Grid Heat Pump Profiles'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  html_document:
    code_folding: hide
    fig_caption: true
    keep_md: true
    number_sections: true
    self_contained: no
    toc: true
    toc_float: true
    toc_depth: 2
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```

```{r codeSetup, include=FALSE}
# Housekeeping ----
rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

# Local parameters ----
fullFb <- 0 # switch on (1) or off (0) full feedback
baTest <- 1 # test (1) or full (0) run?

b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576

gsMasterFile <- path.expand("~/Syncplicity Folders/Green Grid Project Management Folder/Gridspy/Master list of Gridspy units.xlsx")

if(baTest == 1){
  # Local test
  dPath <- "~/Data/NZGreenGrid/gridspy/" # BA laptop test set
  fpath <- paste0(dPath,"1min_orig/") # location of data
  outPath <- paste0(dPath, "consolidated/1min/") # place to save them 
} else {
  # full monty
  dPath <- "/Volumes/hum-csafe/Research Projects/GREEN Grid/" # HPS
  fpath <- paste0(dPath,"_RAW DATA/GridSpyData/") # location of data
  outPath <- paste0(dPath, "Clean_data/safe/gridSpy/1min/") # place to save them 
}

# Load nzGREENGrid package ----
library(nzGREENGrid) # local utilities

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "knitr", # for kable
             "kableExtra" # for extra kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# Local functions ----


```

\newpage

# Status

```{r reportStatus, include = FALSE}
if(baTest){
  msg <- paste0("Test run using reduced data from ", fpath)
} else {
  msg <- paste0("Full run using all data from ", fpath)
}
```

`r msg`

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) GREEN Grid Heat Pump Profiles, University of Otago: Dunedin, NZ.

\newpage

# Introduction

Report circulation:

 * Restricted to: [NZ GREEN Grid](https://www.otago.ac.nz/centre-sustainability/research/energy/otago050285.html) project partners and contractors.

## Purpose

This report is intended to: 

 * load and clean the project electricity power data (Grid Spy)
 * select the Heat Pump circuits (via their labels)
 * build exploratory demand profiles


## Requirements:

 * cleaned and safe grid spy 1 minute data processed via https://git.soton.ac.uk/ba1e12/nzGREENGrid/blob/master/dataProcessing/processNZGGElecCons1minData.Rmd

## History

Generally tracked via our git.soton [repo](https://git.soton.ac.uk/ba1e12/nzGREENGrid):

 * [history](https://git.soton.ac.uk/ba1e12/nzGREENGrid/commits/master)
 * [issues](https://git.soton.ac.uk/ba1e12/nzGREENGrid/issues)
 
## Support

This work was supported by:

 * The [University of Otago](https://www.otago.ac.nz/)
 * The New Zealand [Ministry of Business, Innovation and Employment (MBIE)](http://www.mbie.govt.nz/)
 * [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/) - a [Marie Skłodowska-Curie Global Fellowship](http://ec.europa.eu/research/mariecurieactions/about-msca/actions/if/index_en.htm) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton's Sustainable Energy Research Group (2019-202).
 
This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

We do not 'support' the code but if you have a problem check the [issues](https://git.soton.ac.uk/ba1e12/nzGREENGrid/issues) on our [repo](https://git.soton.ac.uk/ba1e12/nzGREENGrid) and if it doesn't already exist, open one. We might be able to fix it :-)


# Load data files

## Grid Spy metadata

In this section we load metadata from `r gsMasterFile` to link to the power data.

```{r load dmetadata}

unisonDT <- data.table::as.data.table(readxl::read_xlsx(gsMasterFile, sheet = "Unison"))

# keep safe data only
unisonDT <- unisonDT[, .(sample = `Power company`, hhID = `Tag`, 
                         Adults,Teenagers,Children,removed )]
head(unisonDT)

powercoDT <- data.table::as.data.table(readxl::read_xlsx(gsMasterFile, sheet = "Powerco"))
powercoDT <- powercoDT[, .(sample = `Power Co`, hhID = `Building Tag`, 
                           Adults = `Adult`,Teenagers,Children, removed = `date disconnected` )]
head(powercoDT)

# remove NA on rbind
metaDT <- rbind(unisonDT, powercoDT[!is.na(hhID)])
# breaks due to coding of Children
# metaDT <- metaDT[, kasKids := "2+ children"]
# metaDT <- metaDT[, kasKids := ifelse(Children == 0, "No kids", kasKids)]
# metaDT <- metaDT[, kasKids := ifelse(Children %like% 1, "1 child", kasKids)]

metaDT <- metaDT[, nAdults := "1"]
metaDT <- metaDT[, nAdults := ifelse(Adults %like% 2, "2", nAdults)]
metaDT <- metaDT[, nAdults := ifelse(Children %like% 3, "3", nAdults)]


setkey(metaDT, hhID)

kable(caption = "Meta data for sample", metaDT)
```

## Grid Spy data

In this section we load the cleaned data files from `r paste0(outPath,"data/")`. If we loaded all the data at once and then filtered out what we want we might run out of memory so we filter as we load.

```{r set filters, echo=TRUE}
circuitPattern <- "Heat Pump"
dateFrom <- "2015-04-01"
dateTo <- "2016-03-31"
```

```{r load gs data}
# check files to load
fpath <- paste0(outPath,"data/")
pattern <- "*.gz"
fListDT <- nzGREENGrid::getFileList(fpath, pattern)

nFiles <- nrow(fListDT)
print(paste0("Found ", tidyNum(nFiles), " files"))

fListDT <- fListDT[, fullPath := paste0(fpath, fList)] # add in full path as it doesn't return in the function (maybe it should)

gs1MinDT <- data.table() # data collector
filesToLoad <- fListDT[, fullPath]

print(paste0("# Filtering on: ", circuitPattern))
print(paste0("# Date range: ", dateFrom, " - ", dateTo))

gs1MinDT <- getCleanGridSpyData(filesToLoad, circuitPattern, dateFrom, dateTo)

# remove NAs if present
gs1MinDT <- gs1MinDT[!is.na(powerW)]

print("# > Setting useful dates & times")
gs1MinDT <- gs1MinDT[, timeAsChar := format(r_dateTime, format = "%H:%M:%S")]
gs1MinDT <- gs1MinDT[, obsHourMin := hms::as.hms(timeAsChar)] # makes graphs easier
gs1MinDT$timeAsChar <- NULL # drop

print(paste0("# Found ", tidyNum(nrow(gs1MinDT)), " observations matching -> ", circuitPattern, " <- in ", uniqueN(gs1MinDT$hhID), " households between ", dateFrom, " and ", dateTo))
```

The following table summarises the data.

```{r loadFiles}

t <- gs1MinDT[, .(nObs = .N,
                  nHouseholds = uniqueN(hhID),
                  nCircuits = uniqueN(circuit),
                  meanPower = mean(powerW),
                  minDate = min(as.Date(r_dateTime)),
                  maxDate = max(as.Date(r_dateTime))), keyby = .(hhID)]

knitr::kable(caption = "Summary of household grid spy files loaded", t)
```

This table will have a large number (`r tidyNum(nrow(gs1MinDT))`) of obserations driven by the number of different circuit labels. We exttract the 'Heat' related ones below.

# Data quality analysis

Loaded data observation plots. Should match the plot in 

```{r loadedFilesObsPlots}

plotDT <- gs1MinDT[, .(nObs = uniqueN(r_dateTime)), keyby = .(hhID, date = as.Date(r_dateTime))]
setkey(plotDT, hhID)
# tile plot ----
myCaption <- paste0("Data source: ", outPath,
                    "\nUsing data received up to ", max(gs1MinDT$r_dateTime))

myPlot <- ggplot2::ggplot(plotDT[metaDT], aes( x = as.Date(date), y = hhID, 
                               fill = nObs)) +
  geom_tile() +
  scale_fill_gradient(low = "red", high = "green") +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   hjust = 0.5)) + 
  labs(title = "N observations per household per day for all loaded grid spy data",
       caption = myCaption
  )

myPlot + 
  facet_grid(sample ~ .) +
  annotate("rect")

```

```{r plot n obs per hh id as dots}
# point plot ----
myPlot <- ggplot2::ggplot(plotDT[metaDT], aes( x = as.Date(date), 
                               y = nObs, 
                               colour = hhID)) +
  geom_point() +
  #facet_wrap(sample ~ .) +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(title = "N observations per household per day for all loaded grid spy data",
       caption = myCaption
  )
myPlot + facet_grid(sample ~ .)
```

The following table shows the min/max observations per day and min/max dates for each household. As above, we should not see:

 * dates before 2014 or in to the future (indicates date conversion errors)
 * more than 1440 observations per day (indicates potentially duplicate observations)
 * non-integer counts of circuits as it suggests some column errors
 
 We should also not see NA in any row (indicates date conversion errors). 
 
 If we do see any of these then we still have data cleaning work to do!

```{r summaryTable}
# Stats table (so we can pick out the dateTime errors)
setkey(gs1MinDT, hhID)
mergedDT <- gs1MinDT[metaDT]
dt <- mergedDT[, .(nObs = .N,
             minDate = min(r_dateTime),
             maxDate = max(r_dateTime)),
         keyby = .(hhID, sample)]

knitr::kable(caption = "Summary observation stats by hhID (sorted by date last heard from)", dt[order(maxDate)])
```


Finally we show the total number of households which we think are still sending data.

```{r liveDataHouseholds}
plotDT <- mergedDT[, .(nHH = uniqueN(hhID)), keyby = .(date = as.Date(r_dateTime), sample)]

plotDT <- plotDT[sample == "Unison", sample := "Sample 1: Unison" ]
plotDT <- plotDT[sample == "Powerco", sample := "Sample 2: PowerCo" ]

# point plot ----
myPlot <- ggplot2::ggplot(plotDT, aes( x = as.Date(date), y = nHH, fill = sample)) +
  geom_col() +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(title = "N live households per day for all loaded grid spy data",
       caption = myCaption
  )
myPlot

```

# Get Heat Pump data

First we need to select the circuits (columns) which are Heat Pumps. We do this using the string 'Heat Pump' in the column names and selecting the 'best year' from chart above = April 2015 - March 2016.

```{r extract heat pump cols, echo = TRUE}
heatPumpDT <- gs1MinDT[circuit %like% pattern &
                         as.Date(r_dateTime) >= dateFrom &
                         as.Date(r_dateTime) <= dateTo]

t <- summary(heatPumpDT)
kable(caption = "Summary of heat pump circuits", t)
```

```{r heat pump histo}
myCaption <- paste0("Data source: ", outPath,
                    "\nUsing data from ",  min(heatPumpDT$r_dateTime), " to ", max(heatPumpDT$r_dateTime))

ggplot(heatPumpDT, aes(x = powerW)) +
  geom_histogram() +
  labs(title = "Distribution of 'Heat Pump' power",
       caption = myCaption)
```

Why are there negatve values?

Test charts: one for each HH but averaged over year. Keep at 1 minute intervals

```{r add season}
# add season
heatPumpDT <- heatPumpDT[, month := lubridate::month(r_dateTime, label = TRUE)]
heatPumpDT <- heatPumpDT[, season := "Summer"]
heatPumpDT <- heatPumpDT[, season := ifelse(month == "Mar" |
                                              month == "Apr" |
                                              month == "May", "Autumn", season)]
heatPumpDT <- heatPumpDT[, season := ifelse(month == "Jun" |
                                              month == "Jul" |
                                              month == "Aug", "Winter", season)]
heatPumpDT <- heatPumpDT[, season := ifelse(month == "Sep" |
                                              month == "Oct" |
                                              month == "Nov", "Spring", season)]
```



```{r profiles per household by season}
plotDT <- heatPumpDT[!is.na(season), 
                     .(meanW = mean(powerW)), keyby = .(hhID, obsHourMin, season)]
setkey(plotDT, hhID)

myPlot <- ggplot(plotDT, aes(y = meanW, x = obsHourMin, colour = hhID)) +
  geom_point()

myPlot + facet_grid(season ~ .) +
  labs(title = "Mean 'Heat Pump' power (1 minute intervals)",
       caption = myCaption)

```



# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * dplyr - for select and contains [@dplyr]
 * progress - for progress bars [@progress]
 * knitr - to create this document & neat tables [@knitr]
 * kableExtra - for extra neat tables [@kableExtra]
 * nzGREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
