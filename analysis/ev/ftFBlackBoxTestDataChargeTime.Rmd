---
params:
 title: "FlipTheFleet Test Black Box Data: Testing Time of Charging"
 subtitle: "Exploration of test data"
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::pdf_document2: default
  bookdown::html_document2:
    toc: true
    toc_float: true
bibliography: '`r paste0(nzGREENGrid::findParentDirectory("nzGREENGrid"), "/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
options(knitr.table.format = 'markdown') # try to fix the tables issue (seems to be pushing html into latex)
```

```{r codeSetup, include=FALSE}
#rm(list=ls(all=TRUE)) # remove all objects from workspace # <- don't do this - rmeoves params set in yaml!

# Set start time ----
startTime <- proc.time()

library(nzGREENGrid)

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "lubridate", # date & time processing
             "readr", # writing to files
             "knitr" # for kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# run gg set up
nzGREENGrid::setup() # sets a load of parameters which are then accessible via ggParams$xxx

# Local paramaters
ggParams$dataLoc <- path.expand("/Volumes/hum-csafe/Research Projects/GREEN Grid/_RAW DATA/flipTheFleet/")
```

\newpage

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) `r params$title`: `r params$subtitle`, `r ggParams$pubLoc`.

This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

\newpage

# About

## Circulation

```{r generic circulation, child=ggParams$circulationGenericRmd}
```
 
## Purpose

This report is intended to: 

 * load and test preliminary '[black box](https://flipthefleet.org/ev-black-box/)' EV monitoring data provided for assessment purposes by [FlipTheFleet](http://flipthefleet.org/)
 * preliminary analysis of time of charging to understand impact on 'peak' electricity demand

<right>

![The Black Box (Source: FlipTheFleet)](fig/bb.jpg)

</right>

## Requirements:

 * test dataset stored at `r ggParams$dataLoc`

## History

```{r includeHistory, child=ggParams$historyGenericRmd}
```
 
Specific history of this code:

 * https://git.soton.ac.uk/ba1e12/nzGREENGrid/tree/master/analysis/ev

## Support

```{r includeSupport, child=ggParams$supportGenericRmd}
```
 

# Load data files

## EV test data

```{r set fileName}
ggParams$ftfFile <- paste0(ggParams$dataLoc, "EVBlackBox export 2018-06-10-233146.csv")
```

In this section we load and describe the data from `r ggParams$ftfFile`. Note that we remove the following variables before we do so as they are potentially disclosive:

 * `Reg No`
 * `Latitude`
 * `Longitude` 
 * `Course (deg)` 

```{r load ftf data, echo=TRUE}
ftfDT <- data.table::as.data.table(readr::read_csv(ggParams$ftfFile))

# do analysis on safe version
ftfSafeDT <- createSafeFtF(ftfDT)
```

Create some useful derived variables.

```{r process ftf data, echo = TRUE}
# create derived variables
ftfSafeDT <- createDerivedFtF(ftfSafeDT)
```

See [ftFBlackBoxTestDataCodebook.docx](https://www.dropbox.com/s/bfepx3sgfxek78e/ftFBlackBoxTestDataCodebook.docx?dl=0) for a full description of the data. 

Check charger related variables. We think these are:

 * `Charger (amps)`
 * `Charger (V)`

Multiplying these two will give power in W. Figures \@ref(fig:checkAmps) to \@ref(fig:checkPower) examine the distribution of amps, volts and the derived W.

```{r setCaptions}
# for plots
figCaption <- paste0("FlipTheFleet 'Black Box' test data for 1 car for ", 
                     uniqueN(ftfSafeDT$rDate), " days from ",
                     min(ftfSafeDT$rDate, na.rm = TRUE), " to ", max(ftfSafeDT$rDate, na.rm = TRUE))
```

```{r checkAmps, fig.cap="Distribution of charger amp readings"}
ggplot(ftfSafeDT, aes(x = `Charger (amps)`)) +
  geom_histogram(binwidth = 0.1) +
  labs(caption = figCaption)
```

```{r checkVolts, fig.cap="Distribution of charger volt readings"}
ggplot(ftfSafeDT, aes(x = `Charger (V)`)) +
  geom_histogram(binwidth = 5) +
  labs(caption = figCaption)
```

```{r checkPower, fig.cap="Distribution of derived power demand"}

ftfSafeDT <- ftfSafeDT[, powerW := `Charger (amps)` * `Charger (V)`]

ggplot(ftfSafeDT, aes(x = powerW/1000)) +
  geom_histogram(binwidth = 0.1) +
  labs(x = "kW", caption = figCaption)
```

The following table sumarises these distributions.

```{r summaryTable, fig.cap="Summary table"}
t <- summary(ftfSafeDT[, c("Charger (amps)", "Charger (V)", "powerW")])

knitr::kable(caption = "Summary of Charger (amps)", t)
```

_XX Is the Amp reading of 33 an outlier? If so should we ignore the ~= 8kW values? XX_

# Timing of charging

We assume `powerW` is a good indicator of charging. For now we do not exclude the apparent outlier caused by the few very high Amp values (`Charger (amps)` > 30) but we flag them as potential problems.

```{r flagAmpOutliers}
ftfSafeDT <- ftfSafeDT[, ampOutlier := ifelse(`Charger (amps)` > 30, "Possible Amp data error?", "OK Amp data")]
```

The following plot shows mean kW by time of day over the entire test datset of `r uniqueN(ftfSafeDT$rDate)` days from `r min(ftfSafeDT$rDate, na.rm = TRUE)` to `r max(ftfSafeDT$rDate, na.rm = TRUE)`.

```{r plotChargingTime, fig.cap="Inferred charging times and power draw (all data)"}
# set day of the week
ftfSafeDT <- ftfSafeDT[, dow := lubridate::wday(rDate, label = TRUE)]

plotDT <- ftfSafeDT[, .(meanPowerW = mean(powerW)), keyby = .(rTime, dow, ampOutlier)]

myPlot <- ggplot(plotDT, aes(x = rTime, y = meanPowerW/1000, colour = ampOutlier)) +
  geom_point() +
  facet_grid(dow ~ ampOutlier) +
  labs(x='Time of Day', y = "Mean kW", caption = figCaption) +
  theme(legend.position = "bottom") #  legend
  
  myPlot
  
  # myPlot + scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
  #                         hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), hms::as.hms("15:00:00"), 
  #                         hms::as.hms("18:00:00"), hms::as.hms("21:00:00"), hms::as.hms("24:00:00")))
```

Figure \@ref(fig:plotChargingTime) seems to show that the very high Amp values occured on one Sunday. We re-draw this plot (Figure \@ref(fig:plotChargingTimeClean)) excluding these outliers and also excluding values of exactly 0 for clarity.

```{r plotChargingTimeClean, fig.cap="Inferred charging times and power draw (outliers and exactly zero values excluded)"}
myPlot <- ggplot(plotDT[ampOutlier == "OK Amp data" & !is.na(dow) & meanPowerW != 0], aes(x = rTime, y = meanPowerW/1000)) +
  geom_point() +
  facet_grid(dow ~ .) +
  labs(x='Time of Day', y = "Mean kW", caption = figCaption) +
  theme(legend.position = "bottom") #  legend
  
  myPlot + scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                        hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), hms::as.hms("15:00:00"), 
                         hms::as.hms("18:00:00"), hms::as.hms("21:00:00"), hms::as.hms("24:00:00")))
```

We can see that this car appears to be on an overnight charging timer, although we do still see charging scattered through the rest of the day. So where is this charging happening? We need a way to infer when the car is 'at home' without being disclosive. Perhaps we could use the modal overnight `Latitude` <-> `Longtidude` as 'home'?

# Questions to ask

 * Data:
    + Do the Amp & Volt distributions look right?
    + Cause of Amp outliers?
 * Research:
    + Do all FlipTheFleet EV owners charge like this?
    + Where are the EVs being charged and how can we tell?
    + Does it vary by car/tariff/commute pattern/main use?
    + What other patterns exist and how much within-vehicle and between-vehicle variation is there?
   

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * dplyr - for select and contains [@dplyr]
 * knitr - to create this document & neat tables [@knitr]
 * nzGREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
