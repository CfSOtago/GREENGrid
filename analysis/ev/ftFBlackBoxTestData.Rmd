---
title: 'FlipTheFleet Black Box Data Tests'
subtitle: 'Exploration of test data'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  html_document:
    code_folding: hide
    fig_caption: true
    keep_md: true
    number_sections: true
    self_contained: no
    toc: true
    toc_float: true
    toc_depth: 2
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
options(knitr.table.format = 'markdown') # try to fix the tables issue (seems to be pushing html into latex)
```

```{r codeSetup, include=FALSE}
rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

library(nzGREENGrid)

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "readr", # writing to files
             "knitr" # for kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# run gg set up
ggParams <- nzGREENGrid::setup()

# Local paramaters
ggParams$dataLoc <- paste0(nzGREENGrid::findParentDirectory("nzGREENGrid"), "/data/")
```

\newpage

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) FlipTheFleet Black Box Data Tests, `r pubLoc`.

This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

\newpage

# Introduction

Report circulation:

 * Restricted to: [NZ GREEN Grid](https://www.otago.ac.nz/centre-sustainability/research/energy/otago050285.html) project partners and contractors.

## Purpose

This report is intended to: 

 * load and test preliminary 'black box' EV monitoring data provided for assessment purposes by [FlipTheFleet](http://flipthefleet.org/).

## Requirements:

 * test dataset stored at XXX

## History

```{r include=ggParams$historyGenericRmd}
```
 
## Support

```{r include=ggParams$supportGenericRmd}
```
 

# Load data files

## EV test data

In this section we load the cleaned data files from `r paste0(outPath,"data/")`. If we loaded all the data at once and then filtered out what we want we might run out of memory so we filter as we load. Set the filters here:

```{r set filters, echo=TRUE}
circuitPattern <- params$circuitPattern
dateFrom <- params$dateFrom
dateTo <- params$dateTo

plotCaption <- paste0("Source: ", fpath,
                      "\nCircuits: ", circuitPattern, " from ", dateFrom, " to ", dateTo)
```

So we are looking for `r circuitPattern` circuits between `r dateFrom` and `r dateTo`. We do this by checking to see if the extract file has already been created. If so we load it. If not, we create it.

```{r setFile}
fName <- paste0(fName <- paste0(circuitPattern, "_", dateFrom, "_", dateTo, "_observations.csv"))
iFile <- paste0(outPath, "dataExtracts/", fName)
```

The file we are looking for is: `r fName`

```{r load gridSpy data}
# checks if input file exists, if not creates it from files in fPath
fPath <- paste0(outPath, "data/")
gs1MinDT <- nzGREENGrid::getCleanGridSpyData(iFile, fPath, circuitPattern, dateFrom, dateTo)
```

The following table summarises the `r circuitPattern` data we have found.

```{r summarise loaded data}

t <- summary(gs1MinDT)

knitr::kable(caption = paste0("Summary of household grid spy data for: ", circuitPattern), t)
```

This table will have a large number (`r tidyNum(nrow(gs1MinDT))`) of obserations caused by the number of different circuit labels as shown by the following table.

```{r test circuit labels}
t <- table(gs1MinDT$circuit)

knitr::kable(caption = paste0("Counts of ", circuitPattern, " observations by label and household"), t)
```

Note that some households may have more than one `r circuitPattern` circuit.

## Test `r circuitPattern` data

This section tests the availability of `r circuitPattern` data by replicating the standard data quality checks used for the whole [gridSpy dataset](https://git.soton.ac.uk/ba1e12/nzGREENGrid/tree/master/dataProcessing/gridSpy).

The following plot shows loaded data observation plots - just to confirm what `r circuitPattern` data we have. 

```{r loadedFilesObs Tile Plot}

plotDT <- gs1MinDT[, .(nObs = uniqueN(r_dateTime)), keyby = .(hhID, date = as.Date(r_dateTime))]
setkey(plotDT, hhID)

dt <- merge(plotDT, metaDT, allow.cartesian=TRUE) # not sure why we need to do this - shouldn't be duplicate hhIDs?

myPlot <- ggplot2::ggplot(dt, aes( x = as.Date(date), y = hhID, 
                               fill = nObs)) +
  geom_tile() +
  scale_fill_gradient(low = "red", high = "green") +
  scale_x_date(date_labels = "%Y %b", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   hjust = 0.5)) + 
  labs(caption = plotCaption,
       x = "Date"
  )

myPlot + 
  facet_grid(sample ~ .) +
  annotate("rect")

```

The next plot shows the same data but as a dot plot to highlight those households and dates where we did not receive 60 * 24 = 1440 observations per day.

```{r loadedFilesObs point plot}
# point plot ----
myPlot <- ggplot2::ggplot(dt[!is.na(nObs)], aes( x = date, 
                               y = nObs, 
                               colour = hhID)) +
  geom_point() +
  #facet_wrap(sample ~ .) +
  scale_x_date(date_labels = "%Y %b", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(caption = plotCaption,
       x = "Date"
  )
myPlot + facet_grid(sample ~ .)
```

The following table shows the min/max observations per day and min/max dates for each household. As above, we should not see:

 * dates before 2014 or in to the future (indicates date conversion errors)
 * more than 1440 observations per day (indicates potentially duplicate observations)
 * non-integer counts of circuits as it suggests some column errors
 
 We should also not see NA in any row (indicates date conversion errors). 
 
 If we do see any of these then we still have data cleaning work to do!

```{r summaryTable}
# Stats table (so we can pick out the dateTime errors)
setkey(gs1MinDT, hhID)
mergedDT <- merge(gs1MinDT, metaDT,  allow.cartesian=TRUE)

dt <- mergedDT[, .(nObs = .N,
             minDate = min(r_dateTime, na.rm = TRUE),
             maxDate = max(r_dateTime, na.rm = TRUE)),
         keyby = .(hhID, sample)]

knitr::kable(caption = paste0("Summary observation stats by hhID (sorted by date last heard from) for: ", circuitPattern), dt[order(maxDate)])
```

Finally we show the total number of households which we think we have `r circuitPattern` data for.

```{r liveDataHouseholds}
plotDT <- mergedDT[, .(nHH = uniqueN(hhID)), keyby = .(date = as.Date(r_dateTime), sample)]

plotDT <- plotDT[sample == "Unison", sample := "Sample 1: Unison" ]
plotDT <- plotDT[sample == "Powerco", sample := "Sample 2: PowerCo" ]

# point plot ----
myPlot <- ggplot2::ggplot(plotDT, aes( x = date, y = nHH, fill = sample)) +
  geom_col() +
  scale_x_date(date_labels = "%Y %b", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(caption = plotCaption,
       x = "Date"
  )
myPlot

```

The following table summarises the `r circuitPattern` data. Any surprises?

```{r summary of cols, echo = TRUE}
t <- summary(gs1MinDT)
knitr::kable(caption = paste0("Summary of ", circuitPattern, " circuits"), t)

```

We seem to have some negative powerW values and at least one very large power value.

Nasty surprises often lurk in histograms... The following histogram shows all observations.

```{r histo full}
ggplot2::ggplot(gs1MinDT, aes(x = powerW)) +
  geom_histogram(binwidth = 10) +
  labs(caption = plotCaption)
```

The next shows the histogram for powerW < 1000W...

```{r histo power under 1000}
ggplot2::ggplot(gs1MinDT[powerW < 1000], aes(x = powerW)) +
  geom_histogram(binwidth = 10) +
  labs(caption = plotCaption)
```

> There are a lot of zeros (as we'd expect) but why are there negative values?

# `r circuitPattern` profiles

This section produces the profiles as one for each HH but averaged over each season. Data is kept at 1 minute intervals. Note definition of season below...

```{r add season, echo = TRUE}
# add season
gs1MinDT <- gs1MinDT[, month := lubridate::month(r_dateTime, label = TRUE)]
gs1MinDT <- gs1MinDT[, season := "Summer"]
gs1MinDT <- gs1MinDT[, season := ifelse(month == "Mar" |
                                              month == "Apr" |
                                              month == "May", "Autumn", season)]
gs1MinDT <- gs1MinDT[, season := ifelse(month == "Jun" |
                                              month == "Jul" |
                                              month == "Aug", "Winter", season)]
gs1MinDT <- gs1MinDT[, season := ifelse(month == "Sep" |
                                              month == "Oct" |
                                              month == "Nov", "Spring", season)]
```

## Profile plots: means per household

This section shows a plot of mean profiles for each household by season.

```{r profiles per household by season}
# create plot table
plotDT <- gs1MinDT[!is.na(season), 
                     .(meanW = mean(powerW)), keyby = .(hhID, obsHourMin, season)]
setkey(plotDT, hhID)
nHHs <- uniqueN(plotDT$hhID)
myPlot <- ggplot2::ggplot(plotDT, aes(y = meanW, x = obsHourMin, colour = hhID)) +
  geom_point() +
  facet_grid(season ~ .) +
  labs(caption = paste0(plotCaption,"\nn households = ", nHHs),
       x = "Time of Day")
myPlot

# save the plot at high def
plotFile <- paste0(outPath, "profiles/", circuitPattern, "_", dateFrom, "_", dateTo, "_byHouseholdSeasonalProfilePlot.pdf")
ggplot2::ggsave(plotFile,
                height = 10, width = 8, dpi = 400)
print(paste0("Saving plot to ", plotFile))

# save the profiles for future use ----
ofile <- paste0(outPath, "profiles/", circuitPattern, "_", dateFrom, "_", dateTo, "_byHouseholdSeasonalProfiles.csv")
print(paste0("Saving profile data used to build this plot to: ", ofile, "..."))
data.table::fwrite(plotDT, ofile)

cmd <- paste0("gzip -f ", "'", path.expand(ofile), "'") # gzip it - use quotes in case of spaces in file name, expand path if needed
try(system(cmd)) # in case it fails - if it does there will just be .csv files (not gzipped) - e.g. under windows
print(paste0("Gzipped ", ofile))

t <- summary(plotDT)

knitr::kable(caption = paste0("Summary of household level mean profiles for ", circuitPattern),
             t)
```

As we can see there is considerable variation between households in both the level and timing of heat pump demand.

Note that the code saves a high definition version of the plot and the profiles for future re-use.

The .csv.gz file can be loaded using the following code:

 * `df <- readr::read_csv("`r paste0(ofile)`.gz")` or 
 * `dt <- data.table::as.data.table(readr::read_csv("`r paste0(ofile)`.gz"))` if you prefer `data.table`
 

## Profile plots: overall household mean

This section shows a plot of mean and median profiles across all household by season. The mean profile also shows the level of variance by plotting error bars at +/- 1 s.d.

```{r overall profiles by season}
# create plot table
plotDT <- gs1MinDT[!is.na(season), 
                     .(meanW = mean(powerW),
                       medianW = median(powerW),
                       nObs = .N,
                       sdW = sd(powerW)), keyby = .(obsHourMin, season)]

# mean plot ----
myPlot <- ggplot2::ggplot(plotDT, aes(y = meanW, x = obsHourMin, colour = season)) +
  #geom_ribbon(aes(ymin = meanW - sdW, ymax = meanW + sdW, fill = season),alpha = 0.2) +
  geom_errorbar(aes(ymin = meanW - sdW, ymax = meanW + sdW, colour = season), width = 0.4, alpha = 0.2) +
  geom_point() +
  facet_grid(season ~ .) +
  labs(caption = paste0(plotCaption,"\nn households = ", nHHs, "\nError bars = +/- 1 s.d."),
       x = "Time of Day")
myPlot

# save the plot at high def
plotFile <- paste0(outPath, "profiles/", circuitPattern, "_", dateFrom, "_", dateTo, "_overallMeanSeasonalProfilePlot.pdf")
ggplot2::ggsave(plotFile,
                height = 10, width = 8, dpi = 400)
print(paste0("Saving plot to ", plotFile))

# median plot ----
myPlot <- ggplot2::ggplot(plotDT, aes(y = medianW, x = obsHourMin, colour = season)) +
  geom_point() +
  facet_grid(season ~ .) +
  labs(caption = paste0(plotCaption,"\nn households = ", nHHs),
       x = "Time of Day")
myPlot

# save the plot at high def
plotFile <- paste0(outPath, "profiles/", circuitPattern, "_", dateFrom, "_", dateTo, "_overallMedianSeasonalProfilePlot.pdf")
ggplot2::ggsave(plotFile,
                height = 10, width = 8, dpi = 400)
print(paste0("Saving plot to ", plotFile))

# save the profiles for future use ----
ofile <- paste0(outPath, "profiles/", circuitPattern, "_", dateFrom, "_", dateTo, "_overallSeasonalProfiles.csv")
print(paste0("Saving profile data used to build this plot to: ", ofile, "..."))
data.table::fwrite(plotDT, ofile)

cmd <- paste0("gzip -f ", "'", path.expand(ofile), "'") # gzip it - use quotes in case of spaces in file name, expand path if needed
try(system(cmd)) # in case it fails - if it does there will just be .csv files (not gzipped) - e.g. under windows
print(paste0("Gzipped ", ofile))

t <- summary(plotDT)

knitr::kable(caption = paste0("Summary of overall profiles for ", circuitPattern),
             t)
```

The difference between the mean and median plots is instructive - it suggests that the mean plots for summer are skewed by a few higher heat pump-using households.

The plots could be repeated or re-facted e.g. by household size.

As before, the code saves a high definition version of the plot and the profiles for future re-use.
 
# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * dplyr - for select and contains [@dplyr]
 * progress - for progress bars [@progress]
 * knitr - to create this document & neat tables [@knitr]
 * nzGREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
