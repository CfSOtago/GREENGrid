---
params:
 title: "FlipTheFleet Black Box Data Tests"
 subtitle: "Testing Time of Charging"
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
  bookdown::pdf_document2: default
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo

```

```{r codeSetup, include=FALSE}
#rm(list=ls(all=TRUE)) # remove all objects from workspace # <- don't do this - rmeoves params set in yaml!

# Set start time ----
startTime <- proc.time()

library(dkUtils) # my utils :-) get this via devtools::install_github("dataknut/dkUtils")

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "lubridate", # date & time processing
             "readr", # writing to files
             "Hmisc", # describe
             "codebook", # codebook
             "skimr", # for skim
             "GREENGrid", # ftf functions
             "kableExtra" # for smart kable
)
# load them
dkUtils::loadLibraries(rmdLibs)

# run gg set up
GREENGrid::setup() # sets a load of parameters which are then accessible via ggParams$xxx

# Local paramaters ----
ggParams$dataLoc <- path.expand("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/flipTheFleet/")
dFile <- paste0(ggParams$dataLoc, "safe/ftfSafeLatestAll.csv.gz") # safe data file 
```

\newpage

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) _`r params$title`: `r params$subtitle`_, `r ggParams$pubLoc`.

This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton. Re-use is governed by [this license](https://github.com/CfSOtago/GREENGrid/blob/master/LICENSE).

\newpage

# About

## Circulation

```{r generic circulation, child=ggParams$circulationGenericRmd}
```
 
## Purpose

This report is intended to: 

 * load and test preliminary '[black box](https://flipthefleet.org/ev-black-box/)' (see Figure \@ref(fig:blackBox)) EV monitoring data provided for assessment purposes by [FlipTheFleet](http://flipthefleet.org/)
 * preliminary analysis of time of charging to understand impact on 'peak' electricity demand

```{r blackBox, fig.cap="The Black Box (Source: FlipTheFleet)", fig.align="right", dpi=96}
knitr::include_graphics("fig/bb.jpg")
```

## Requirements:

 * test FlipTheFleet black box dataset stored on `r ggParams$otagoHCS` at: `r dFile`

## Code and report history

```{r includeHistory, child=ggParams$historyGenericRmd}
```
 
Specific history of this code:

 * https://git.soton.ac.uk/ba1e12/nzGREENGrid/tree/master/analysis/ev

## Support

```{r includeSupport, child=ggParams$supportGenericRmd}
```
 
## Notes

This document was created using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`. Some of the R code has been included where used for information and reference purposes. Full code is [available](https://github.com/CfSOtago/GREENGrid/tree/master/analysis/ev) as noted above.

# Load and check data

## Load data

In this section we load and describe the pre-processed safe data from `r dFile`. First we load the data.

```{r load ftf data, echo=TRUE}
ftfSafeDT <- data.table::as.data.table(readr::read_csv(dFile))
```

That loaded `r tidyNum(nrow(ftfDT))` observations.

Next we check for NA in dates and other key variables.

```{r check ftf data, echo = TRUE}
t <- ftfDT[is.na(rDate), .(nObs = .N,
                           meanPackVolts = mean(`Pack volts`)), 
           keyby = .(`Date (GPS)`, `Time (GPS)`)]

kableExtra::kable(caption = "Number of obs and mean pack volts where date cannot be set by original GPS Date and Time", t) %>% kable_styling()

t <- ftfDT[is.na(rTime), .(nObs = .N,
                           meanPackVolts = mean(`Pack volts`)), 
           keyby = .(`Date (GPS)`, `Time (GPS)`)]

kableExtra::kable(caption = "Number of obs and mean pack volts where time cannot be set by original GPS Date and Time", t) %>% kable_styling()

```

We remove these NAs from the data 

> _XX (should we - what does GPS NA mean? no signal?) XX _

```{r removeNA}
# remove NA dates
before <- nrow(ftfDT)
ftfDT <- ftfDT[!is.na(rDate)]
after <- nrow(ftfDT)

pcGPSNA <- round((before - after)/before*100, 2)
```

Doing so removed `r before - after` (`r pcGPSNA` %) observations.

## Check variables of interest for this analysis

Check charger related variables. These are:

 * `Pack amps`
 * `Pack volts`

> DM: "To determine charger power the variables 'Pack volts' and 'Pack amps' give you everything you need (with some extra code to separate out regen, and it is also useful to do some deltas of voltage and SoC over time to deal with noise in the current sensors)."

Multiplying these two will give power in W. Figures \@ref(fig:checkAmps) to \@ref(fig:checkPower) examine the distribution of amps, volts and the derived W.

```{r setCaptions}
# for plots
figCaption <- paste0("FlipTheFleet 'Black Box' test data for ", uniqueN(ftfDT$evID), " vehicles over " ,
                     uniqueN(ftfDT$rDate), " days from ",
                     min(ftfDT$rDate, na.rm = TRUE), " to ", max(ftfDT$rDate, na.rm = TRUE))
```

> Does negative Amps (Figure \@ref(fig:checkAmps)) indicate regeneration or charging or...? 

```{r checkAmps, fig.cap="Distribution of Pack amp readings by car"}
ggplot(ftfDT, aes(x = `Pack amps`)) +
  geom_histogram(binwidth = 0.1) +
  facet_grid(evID ~ .) +
  labs(caption = figCaption)
```

```{r checkVolts, fig.cap="Distribution of charger volt readings"}
ggplot(ftfDT, aes(x = `Pack volts`)) +
  geom_histogram(binwidth = 5) +
  facet_grid(evID ~ .) +
  labs(caption = figCaption)
```

```{r checkPower, fig.cap="Distribution of derived power demand"}

ftfDT <- ftfDT[, powerW := `Pack volts` * `Pack amps`]

ggplot(ftfDT, aes(x = powerW/1000)) +
  geom_histogram(binwidth = 0.1) +
  facet_grid(evID ~ .) +
  labs(x = "kW", caption = figCaption)
```

The following table sumarises these distributions.

```{r summaryTable, fig.cap="Summary table"}
t <- summary(ftfDT[, c("Pack amps", "Pack volts", "powerW")])

kableExtra::kable(caption = "Summary", t) %>% kable_styling()
```

Clearly we need to do some outlier analysis. In general we would not expect voltage to be higher than 

# Analaysis: Number of cars over time

Just a simple trend line...

```{r carTrends}
plotDT <- ftfDT[, .(obs = .N), keyby = .(evID, rDate)]

ggplot2::ggplot(plotDT, aes(x = rDate, y = obs, colour = evID)) +
  geom_line() +
  theme(legend.position="bottom") +
  labs(x = "Date",
       y = "Number of observations per day",
       caption = figCaption)
```

# Analaysis: Charging over time over time

```{r chargingTable}
dt <- ftfDT[, .(meankW = mean(powerW/1000),
                sdkW = sd(powerW/1000),
                mediankW = median(powerW/1000)), keyby = .(evID)]

kableExtra::kable(dt, caption = "Summary of charging (powerW) per car") %>% 
  kable_styling()
```

Visualise as a simple trend line...

```{r carTrends}
plotDT <- ftfDT[, .(meankW = mean(powerW)/1000), keyby = .(evID, rDate)]

ggplot2::ggplot(plotDT, aes(x = rDate, y = meankW, colour = evID)) +
  geom_line() +
  theme(legend.position="bottom") +
  labs(x = "Date",
       y = "Mean power (kW) per day",
       caption = figCaption)
```

# Analysis: Timing of charging

We assume `powerW` is a good indicator of charging. 

```{r flagAmpOutliers}
ftfDT <- ftfDT[, ampOutlier := ifelse(`Charger (amps)` > 30, "Possible Amp data error?", "OK Amp data")]
```

Figure \@ref(fig:plotChargingTime) shows mean kW by time of day over the entire test datset of `r uniqueN(ftfDT$rDate)` days from `r min(ftfDT$rDate, na.rm = TRUE)` to `r max(ftfDT$rDate, na.rm = TRUE)`.

```{r plotChargingTime, fig.cap="Inferred charging times and power draw (all data)"}
plotDT <- ftfDT[, .(meanPowerW = mean(powerW)), keyby = .(rTime, rDow, ampOutlier,geoLoc, evID)]

myPlot <- ggplot(plotDT, aes(x = rTime, y = meanPowerW/1000, colour = evID)) +
  geom_point() +
  facet_grid(evID + rDow ~ ampOutlier + geoLoc) +
  labs(x='Time of Day', y = "Mean kW", caption = figCaption) +
  theme(legend.position = "bottom") #  legend
  
  myPlot
  
  # myPlot + scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
  #                         hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), hms::as.hms("15:00:00"), 
  #                         hms::as.hms("18:00:00"), hms::as.hms("21:00:00"), hms::as.hms("24:00:00")))
```

Figure \@ref(fig:plotChargingTime) seems to show that the very high Amp values occured on one Sunday and we also appear to see some night charging 'not at home' which may indicate our location inference is imperfect. Figure \@ref(fig:plotChargingTimeClean) re-draws this plot excluding the potential Amp errors and taking the mean for weekends and weekdays for clarity.

```{r plotChargingTimeClean, fig.cap="Inferred charging times and power draw (outliers and exactly zero values excluded)", fig.height=6}
ftfDT <- ftfDT[, rWday := "Mon-Fri"]
ftfDT <- ftfDT[rDow == "Sun", rWday := "Sun"]
ftfDT <- ftfDT[rDow == "Sat", rWday := "Sat"]

plotDT <- ftfDT[, .(meanPowerkW = mean(powerW)/1000), keyby = .(rTime, rWday, ampOutlier,geoLoc, evID)]
  
myPlot <- ggplot(plotDT[ampOutlier == "OK Amp data"], aes(x = rTime, y = meanPowerkW, colour = evID)) +
  geom_point() +
  facet_grid(evID + rWday ~ geoLoc) +
  labs(x='Time of Day', y = "Mean kW", caption = figCaption) +
  theme(legend.position = "bottom") #  legend
  
myPlot + scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("06:00:00"),
                        hms::as.hms("12:00:00"), hms::as.hms("18:00:00"), hms::as.hms("24:00:00")))
```

We can see that one of the cars appears to be on an overnight charging timer at home although we do still see charging scattered through the rest of the day. 

So where is the non-home charging happening? We need a way to infer other locations without being disclosive.

# Conclusions

Questions to be asked

 * Data:
    + Do the Amp & Volt distributions look right?
    + Cause of Amp outliers?
    + Date/Time NA (`r pcGPSNA` % of observations) are due to a lack of GPS date/time (and lat/long). Does this mean that there is no date/time in the data when GPS has no signal? Our tests suggest that other data (e.g. power etc) is logged even though there is no date/time. Do we need another source of date/time? Could we infer time from seconds since powered on (assumes GPS OK at start-up?)?
 * Research:
    + Do all FlipTheFleet EV owners charge like this?
    + Where are the EVs being charged when not at home and how can we tell?
    + Does it vary by car/tariff/commute pattern/main use?
    + What other patterns exist and how much within-vehicle and between-vehicle variation is there?
   

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * openssl - for hashing `Reg No` [@openssl]
 * knitr - to create this document & neat tables [@knitr]
 * GREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
