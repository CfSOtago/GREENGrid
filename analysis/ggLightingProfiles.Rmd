---
title: 'GREEN Grid Lighting Profiles'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    code_folding: hide
    fig_caption: true
    keep_md: true
    number_sections: true
    self_contained: no
    toc: true
    toc_float: true
    toc_depth: 2
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```

```{r codeSetup, include=FALSE}
# Housekeeping ----
rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

# Local parameters ----
fullFb <- 0 # switch on (1) or off (0) full feedback
baTest <- 1 # test (1) or full (0) run?

b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576

gsMasterFile <- path.expand("~/Syncplicity Folders/Green Grid Project Management Folder/Gridspy/Master list of Gridspy units.xlsx")

if(baTest == 1){
  # Local test
  dPath <- "~/Data/NZGreenGrid/" # BA laptop test set
  fpath <- paste0(dPath,"gridspy/1min_orig/") # location of original data
  outPath <- paste0(dPath, "safe/gridSpy/1min/") # place to save them / load from
} else {
  # full monty
  dPath <- "/Volumes/hum-csafe/Research Projects/GREEN Grid/" # HPS
  fpath <- paste0(dPath,"_RAW DATA/GridSpyData/") # location of data
  outPath <- paste0(dPath, "Clean_data/safe/gridSpy/1min/") # place to save them 
}

# Load nzGREENGrid package ----
library(nzGREENGrid) # local utilities

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "readr", # writing to files
             "knitr", # for kable
             "kableExtra" # for extra kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# Local functions ----


```

\newpage

# Status

```{r reportStatus, include = FALSE}
if(baTest){
  msg <- paste0("Test run using reduced data from ", fpath)
} else {
  msg <- paste0("Full run using all data from ", fpath)
}
```

`r msg`

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) GREEN Grid Lighting Profiles, University of Otago: Dunedin, NZ.

\newpage

# Introduction

Report circulation:

 * Restricted to: [NZ GREEN Grid](https://www.otago.ac.nz/centre-sustainability/research/energy/otago050285.html) project partners and contractors.

## Purpose

This report is intended to: 

 * load and clean the project electricity power data (Grid Spy)
 * select the Lighting circuits (via their labels)
 * build exploratory demand profiles

## Requirements:

 * cleaned and safe grid spy 1 minute data processed via https://git.soton.ac.uk/ba1e12/nzGREENGrid/blob/master/dataProcessing/processNZGGElecCons1minData.Rmd

## History

Generally tracked via our git.soton [repo](https://git.soton.ac.uk/ba1e12/nzGREENGrid):

 * [history](https://git.soton.ac.uk/ba1e12/nzGREENGrid/commits/master)
 * [issues](https://git.soton.ac.uk/ba1e12/nzGREENGrid/issues)
 
## Support

This work was supported by:

 * The [University of Otago](https://www.otago.ac.nz/)
 * The New Zealand [Ministry of Business, Innovation and Employment (MBIE)](http://www.mbie.govt.nz/)
 * [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/) - a [Marie Skłodowska-Curie Global Fellowship](http://ec.europa.eu/research/mariecurieactions/about-msca/actions/if/index_en.htm) based at the University of Otago’s [Centre for Sustainability](http://www.otago.ac.nz/centre-sustainability/staff/otago673896.html) (2017-2019) & the University of Southampton's Sustainable Energy Research Group (2019-202).
 
This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

We do not 'support' the code but if you have a problem check the [issues](https://git.soton.ac.uk/ba1e12/nzGREENGrid/issues) on our [repo](https://git.soton.ac.uk/ba1e12/nzGREENGrid) and if it doesn't already exist, open one. We might be able to fix it :-)


# Load data files

## Grid Spy metadata

In this section we load metadata from `r gsMasterFile` to link to the power data.

```{r load metadata}

unisonDT <- data.table::as.data.table(readxl::read_xlsx(gsMasterFile, sheet = "Unison"))

# keep safe data only
unisonDT <- unisonDT[, .(sample = `Power company`, hhID = `Tag`, 
                         Adults,Teenagers,Children,removed )]
head(unisonDT)

powercoDT <- data.table::as.data.table(readxl::read_xlsx(gsMasterFile, sheet = "Powerco"))
powercoDT <- powercoDT[, .(sample = `Power Co`, hhID = `Building Tag`, 
                           Adults = `Adult`,Teenagers,Children, removed = `date disconnected` )]
head(powercoDT)

# remove NA on rbind
metaDT <- rbind(unisonDT, powercoDT[!is.na(hhID)])
# breaks due to coding of Children
# metaDT <- metaDT[, kasKids := "2+ children"]
# metaDT <- metaDT[, kasKids := ifelse(Children == 0, "No kids", kasKids)]
# metaDT <- metaDT[, kasKids := ifelse(Children %like% 1, "1 child", kasKids)]

metaDT <- metaDT[, nAdults := "1"]
metaDT <- metaDT[, nAdults := ifelse(Adults %like% 2, "2", nAdults)]
metaDT <- metaDT[, nAdults := ifelse(Children %like% 3, "3", nAdults)]


setkey(metaDT, hhID)

kable(caption = "Meta data for sample", metaDT)
```

## Grid Spy data

In this section we load the cleaned data files from `r paste0(outPath,"data/")`. If we loaded all the data at once and then filtered out what we want we might run out of memory so we filter as we load. Set the filters here:

```{r set filters, echo=TRUE}
circuitPattern <- "Lighting"
dateFrom <- "2015-04-01"
dateTo <- "2016-03-31"

plotCaption <- paste0("Source: ", fpath,
                      "\nCircuits: ", circuitPattern, " from ", dateFrom, " to ", dateTo)
```

So we are looking for `r circuitPattern` circuits between `r dateFrom` and `r dateTo`. We do this by checking to see if the extract file has already been created. If so we load it. If not, we create it.

```{r setFile}
fName <- paste0(fName <- paste0(circuitPattern, "_", dateFrom, "_", dateTo, "_observations.csv"))
iFile <- paste0(outPath, "dataExtracts/", fName)
```

The file we are looking for is: `r fName`

```{r load gridSpy data}
# checks if input file exists, if not creates it from files in fPath
fPath <- paste0(outPath, "data/")
gs1MinDT <- nzGREENGrid::getCleanGridSpyData(iFile, fPath, circuitPattern, dateFrom, dateTo)
```

The following table summarises the `r circuitPattern` data we have found.

```{r sumamrise loaded data}

t <- gs1MinDT[, .(nObs = .N,
                  nHouseholds = uniqueN(hhID),
                  nCircuits = uniqueN(circuit),
                  meanPower = mean(powerW),
                  minDate = min(as.Date(r_dateTime)),
                  maxDate = max(as.Date(r_dateTime))), keyby = .(hhID)]

knitr::kable(caption = paste0("Summary of household grid spy data for: ", circuitPattern), t)
```

This table will have a large number (`r tidyNum(nrow(gs1MinDT))`) of obserations caused by the number of different circuit labels as shown by the following table.

```{r test circuit labels}
t <- table(gs1MinDT$circuit,gs1MinDT$hhID)

kable(caption = paste0("Counts of ", circuitPattern, " observations by label & household"), t)
```

Note that some households may have more than one `r circuitPattern` circuit.

## Test `r circuitPattern` data

This section tests the availability of `r circuitPattern` data by replicating the standard data quality checks used for the whole [gridSpy dataset](https://git.soton.ac.uk/ba1e12/nzGREENGrid/tree/master/dataProcessing/gridSpy).

The following plot shows loaded data observation plots - just to confirm what `r circuitPattern` data we have. 

```{r loadedFilesObs Tile Plot}

plotDT <- gs1MinDT[, .(nObs = uniqueN(r_dateTime)), keyby = .(hhID, date = as.Date(r_dateTime))]
setkey(plotDT, hhID)

myPlot <- ggplot2::ggplot(plotDT[metaDT], aes( x = as.Date(date), y = hhID, 
                               fill = nObs)) +
  geom_tile() +
  scale_fill_gradient(low = "red", high = "green") +
  scale_x_date(date_labels = "%Y %b", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   hjust = 0.5)) + 
  labs(caption = plotCaption,
       x = "Date"
  )

myPlot + 
  facet_grid(sample ~ .) +
  annotate("rect")

```

The next plot shows the same data but as a dot plot to highlight those households and dates where we did not receive 60 * 24 = 1440 observations per day.

```{r loadedFilesObs point plot}
# point plot ----
dt <- plotDT[metaDT]
myPlot <- ggplot2::ggplot(dt[!is.na(nObs)], aes( x = as.Date(date), 
                               y = nObs, 
                               colour = hhID)) +
  geom_point() +
  #facet_wrap(sample ~ .) +
  scale_x_date(date_labels = "%Y %b", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(caption = plotCaption,
       x = "Date"
  )
myPlot + facet_grid(sample ~ .)
```

The following table shows the min/max observations per day and min/max dates for each household. As above, we should not see:

 * dates before 2014 or in to the future (indicates date conversion errors)
 * more than 1440 observations per day (indicates potentially duplicate observations)
 * non-integer counts of circuits as it suggests some column errors
 
 We should also not see NA in any row (indicates date conversion errors). 
 
 If we do see any of these then we still have data cleaning work to do!

```{r summaryTable}
# Stats table (so we can pick out the dateTime errors)
setkey(gs1MinDT, hhID)
mergedDT <- gs1MinDT[metaDT]
dt <- mergedDT[, .(nObs = .N,
             minDate = min(r_dateTime, na.rm = TRUE),
             maxDate = max(r_dateTime, na.rm = TRUE)),
         keyby = .(hhID, sample)]

knitr::kable(caption = paste0("Summary observation stats by hhID (sorted by date last heard from) for: ", circuitPattern), dt[order(maxDate)])
```

Finally we show the total number of households which we think we have `r circuitPattern` data for.

```{r liveDataHouseholds}
plotDT <- mergedDT[, .(nHH = uniqueN(hhID)), keyby = .(date = as.Date(r_dateTime), sample)]

plotDT <- plotDT[sample == "Unison", sample := "Sample 1: Unison" ]
plotDT <- plotDT[sample == "Powerco", sample := "Sample 2: PowerCo" ]

# point plot ----
myPlot <- ggplot2::ggplot(plotDT, aes( x = as.Date(date), y = nHH, fill = sample)) +
  geom_col() +
  scale_x_date(date_labels = "%Y %b", date_breaks = "2 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(caption = plotCaption,
       x = "Date"
  )
myPlot

```

The following table summarises the `r circuitPattern` data. Any surprises?

```{r summary of cols, echo = TRUE}
t <- summary(gs1MinDT)
kable(caption = paste0("Summary of ", circuitPattern, " circuits"), t)

```

We seem to have some negative powerW values and at least one very large power value.

Nasty surprises often lurk in histograms... The following histogram shows all observations.

```{r histo full}
ggplot2::ggplot(gs1MinDT, aes(x = powerW)) +
  geom_histogram(binwidth = 10) +
  labs(caption = plotCaption)
```

The next shows the histogram for powerW < 1000W...

```{r histo power under 1000}
ggplot2::ggplot(gs1MinDT[powerW < 1000], aes(x = powerW)) +
  geom_histogram(binwidth = 10) +
  labs(caption = plotCaption)
```

> There are a lot of zeros (as we'd expect) but why are there negative values?

Finally we plot the empirical cumulative distribution function ([ECDF](http://ggplot2.tidyverse.org/reference/stat_ecdf.html)) to understand the shape.

```{r cum sum}
subSample <- floor(nrow(gs1MinDT)/10)

testDT <- gs1MinDT[sample(nrow(gs1MinDT), subSample), ]

testDT <- testDT[order(powerW)]
testDT <- testDT[, powerWcumSum := cumsum(powerW)]

plot(testDT$powerWcumSum)

ggplot2::ggplot(testDT, aes(x=powerW)) + stat_ecdf(geom = "step") +
  labs(caption = plotCaption) # http://ggplot2.tidyverse.org/reference/stat_ecdf.html
```

# `r circuitPattern` profiles

This section produces the profiles as one for each HH but averaged over each season. Data is kept at 1 minute intervals. Note definition of season below...

```{r add season, echo = TRUE}
# add season
gs1MinDT <- gs1MinDT[, month := lubridate::month(r_dateTime, label = TRUE)]
gs1MinDT <- gs1MinDT[, season := "Summer"]
gs1MinDT <- gs1MinDT[, season := ifelse(month == "Mar" |
                                              month == "Apr" |
                                              month == "May", "Autumn", season)]
gs1MinDT <- gs1MinDT[, season := ifelse(month == "Jun" |
                                              month == "Jul" |
                                              month == "Aug", "Winter", season)]
gs1MinDT <- gs1MinDT[, season := ifelse(month == "Sep" |
                                              month == "Oct" |
                                              month == "Nov", "Spring", season)]
```

Profile plots:

```{r profiles per household by season}
# create plot table
plotDT <- gs1MinDT[!is.na(season), 
                     .(meanW = mean(powerW)), keyby = .(hhID, obsHourMin, season)]
setkey(plotDT, hhID)

myPlot <- ggplot2::ggplot(plotDT, aes(y = meanW, x = obsHourMin, colour = hhID)) +
  geom_point() +
  facet_grid(season ~ .) +
  labs(caption = plotCaption,
       x = "Time of Day")
myPlot

# save the plot at high def
ggplot2::ggsave(paste0(circuitPattern, "_", dateFrom, "_", dateTo, "_profilePlot.png"),
                height = 10, width = 8, dpi = 400)

# save the profiles for future use ----
ofile <- paste0(circuitPattern, "_", dateFrom, "_", dateTo, "_meanW_hhID_profiles_by_season.csv")
print(paste0("Saving profile data used to build this plot to: ", ofile, "..."))
readr::write_csv(plotDT, ofile)

cmd <- paste0("gzip -f ", "'", path.expand(ofile), "'") # gzip it - use quotes in case of spaces in file name, expand path if needed
try(system(cmd)) # in case it fails - if it does there will just be .csv files (not gzipped) - e.g. under windows
print(paste0("Gzipped ", ofile))
```

Note that the code saves a high definition version of the chart (to the repo) and the average profiles out to a .csv file (in `r outPath`) for future re-use.

The plots could be repeats or re-facted e.g. by household size.

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * dplyr - for select and contains [@dplyr]
 * progress - for progress bars [@progress]
 * knitr - to create this document & neat tables [@knitr]
 * kableExtra - for extra neat tables [@kableExtra]
 * nzGREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
