---
title: "NZ Electricity Generation Trends 1998-2017"
author: "Ben Anderson (b.anderson@soton.ac.uk `@dataknut`)"
date: 'Last run at: `r Sys.time()`'
output:
  pdf_document:
    toc: yes
  html_document:
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    self_contained: no
    toc: yes
    toc_float: yes
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
options(knitr.table.format = 'markdown') # try to fix the tables issue (seems to be pushing html into latex)
```


```{r codeSetup, include=FALSE}
rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

library(nzGREENGrid)

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "readr", # writing to files
             "skimr", # for skim
             "knitr" # for kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# run gg set up
nzGREENGrid::setup()

# Local paramaters
local <- 0 # set to 1 for local file storage (see below)

if(local){ # set data storage location
  lDataLoc <- path.expand("~/Data/NZGreenGrid/safe/ea/")
} else {
  lDataLoc <- path.expand("/Volumes/hum-csafe/Research Projects/GREEN Grid/_RAW DATA/EA_Generation_Data/")
}
ggParams$figCaption <- paste0("Source: EA wholesale generation data",
                              "\nhttps://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/")

```

\newpage

# Citation

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) _NZ Electricity Generation Trends 1998-2017_, `r ggParams$pubLoc`.

This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

\newpage

# About

## Circulation

```{r generic circulation, child=ggParams$circulationGenericRmd}
```
 
## Purpose

This report is intended to: 

 * load and test NZ electricity generation data from https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/ from 1998 to 2017.

## Requirements:

 * pre-downloaded NZ wholesale generation datasets

## History

```{r generic history, child=ggParams$historyGenericRmd}
```
 
Specific history of this code: 

 * https://git.soton.ac.uk/ba1e12/nzGREENGrid/commits/master/analysis/generation/nzGenerationHistory.Rmd

## Support

```{r genric support, child=ggParams$supportGenericRmd}
```
 

# Introduction

Inspired by Steffel ([2018](https://www.sciencedirect.com/science/article/pii/S0301421516307017)) which analyses trends in the type and timing of generation in the UK over the same time period. Intended to build on Kahn et al's 2018 CO2 [intensity of peak demand](https://www.sciencedirect.com/science/article/pii/S0959652618306474?via%3Dihub) paper - how have thngs changed over time?

Uses https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/ from 1998 to 2017.

Data is kWh - so energy not power.

# Load data

Load the generation data from files stored in:

 * `r lDataLoc`
 
These have been [pre-downloaded and cleaned](https://git.soton.ac.uk/ba1e12/nzGREENGrid/tree/master/dataProcessing/ea) but could be pulled on the fly to be refreshed for other dates...

```{r load the generation data}
filesToDateDT <- data.table::as.data.table(list.files(lDataLoc, "long.csv.gz")) # get list of files already downloaded & converted to long form

# for our purposes here we will just use Jun & Dec in 1998 & 2017
filesToDateDT <- filesToDateDT[, c("year","month", "stub") := tstrsplit(V1, "_")]
filesToLoadDT <- filesToDateDT[(year == 1998 | year == 2017) & (month == "06" | month == "12"), V1]


genDT <- as.data.table(do.call(rbind,
                               lapply(filesToLoadDT,
                                      function(f)
                                        readr::read_csv(paste0(lDataLoc,f),
                                                        progress = FALSE,
                                                        col_types = cols()
                                        ) # decodes .gz on the fly, requires readr, use the NULL col_types to suppress feedback
                                      # https://blog.rstudio.org/2016/08/05/readr-1-0-0/
                               )
)
)

# fix vars ----
genDT <- genDT[, rTime := hms::as.hms(rTime)]

print("Files loaded")
print(paste0("Loaded ", tidyNum(nrow(genDT)), " rows of data"))
```

The following table sumamrises the data.

```{r summarise final data table}
t <- summary(genDT)
# note the chunk names needs to be unique
knitr::kable(t, caption = "Summary table")
```

Notice that there are missing (NA) values in the kWh column. These are caused by periods 49 and 50 being missing:

> "The data is presented by trading period, TP1, TP2, ... TP48. Trading period 1 starts at midnight, trading period 2 starts at 12:30am, trading period 3 starts at 1:00am, etc. Users of this data should be aware of daylight saving in New Zealand. On the day daylight saving commences there are only 46 trading periods and on the day it ends, there are 50." (https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/)

Daylight saving begins/ends in October and March so we carefully avoid this problem by using June and December. However these TP are still present as NA in the data as the following table and plot of NA observations (only) by Fuel Type and month show.

```{r explore NA, fig.cap="Plot showing presence of NA observations by time period and Fuel Type"}
dt <- genDT[, .(mean = mean(kWh)), keyby = .(Time_Period)]
kable(caption = "Mean kWh by Time Period", dt)

genDT <- genDT[, kWhisNA := ifelse(is.na(kWh), "NA", "Not NA")] # label NAs

naPlotDT <- genDT[, .(nObs = .N), keyby = .(year, month, Time_Period, Fuel_Code, kWhisNA)] # table them for plot

# plot the NAs by Time_Period to look for patterns
ggplot(naPlotDT[kWhisNA == "NA"], aes(x = month, y = Time_Period, fill = nObs)) + 
  geom_tile() +
  facet_grid(year  ~ Fuel_Code) +
      labs(x = "Month", title = "NA kWh values only",
         caption = ggParams$figCaption
    )
```

In order to avoid future confusion and to save a lot of error checking we remove NA kWh (i.e. TP49 & TP 50) from the dataset.

```{r remove TP49-50, echo = TRUE}
# N rows before:
nrow(genDT)
# N time periods before:
uniqueN(genDT$Time_Period)
# remove NA
genDT <- genDT[!is.na(kWh)]
# N rows after
nrow(genDT)
# N time periods after:
uniqueN(genDT$Time_Period)
```

# Analysis: 1998 & 2017 Comparison

## Distribution tests

The following table shows summary statistics for each fuel source by year. Hydro contributes the majority of energy in each year but coal has the highest half-hourly mean in each year suggesting that is makes large contributions at specific times. Comparing the mean and median for coal shows how skewed this distirbution was in 1998 although far less so in 2017. This is also supported by the maximum values which show coal as the 'peaked' energy producer in 1998 although this has faded by 2017 where it shows similar maxima to gas and hydro. Note that 2 of the 4 the Huntly coal-fired units were [mothballed/retired](https://en.wikipedia.org/wiki/Huntly_Power_Station) during this period.

The boxplot shows the distribution of half-hourly observations by month and year. It clearly shows the use of coal in June 1998, non-use in December 1998 but re-use in December 2017 where there appears little differnece between winter & summer use for most fuels. We also see the emergence of wind by 2017.

```{r distribution tests, fig.height=6}
t <- genDT[, .(sumMWh = sum(kWh)/1000,
               meanMWh = mean(kWh)/1000,
           medianMWh =median(kWh)/1000,
           minMWh = min(kWh)/1000,
           maxMWh = max(kWh)/1000,
           sdMWh = sd(kWh)/1000), keyby = .(year, Fuel_Code)]
kable(caption = "Summary of energy produce by all fuels", t, digits = 2)

ggplot(genDT, aes(x = Fuel_Code, y = kWh/1000, colour = Fuel_Code)) + 
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  facet_grid(month ~ year) +
  labs(x = "Fuel", y = "MWh")
```

The next series of plots use histograms to visualise the distribution of MWh values within fuel sources. Note that the vertical axis has been allowed to vary by fuel source so that smaller counts are visible. The y axis is constant which enables the higher unit output of coal to be clearly visible. The histogram for coal shows the use of multiple units in June 1998 but not 2017 for example. It also shows that coal was almost constantly generating in 2017 (very few zero values). Hydro on the other hand shows a large number of zero or low values as does wind and back-up diesel which is to be expected.

```{r overall histograms, fig.height=6}
ggplot(genDT, aes(x = kWh/1000, fill = Fuel_Code), alpha = 0.2) +
  geom_histogram() + 
  facet_grid(Fuel_Code ~ year, scales = "free_y") + 
  labs(x = "MWh")
```


## Monthly generation

The following plot shows the total, mean, s.d. and coefficient of variation plots of half-hourly GWh produced by each fuel source each month and to some extent relfects the previous box plots. 

```{r monthly summary}
plotDT <- genDT[, 
                .(sumkWh = sum(kWh, na.rm = TRUE),
                  meankWh = mean(kWh, na.rm = TRUE),
                  mediankWh = median(kWh, na.rm = TRUE),
                  sdkWh = sd(kWh, na.rm = TRUE),
                  nObs = .N),
                keyby = .(month, year, Fuel_Code)]
```

The total is simply the sum of all half-hourly values and it shows the dominance of hydro followed by coal in June 1998; the non-use of coal in December 1998; the growth of gas & geo by 2017 but the relative stasis in at-capacity hydro (?).

```{r total plot}
ggplot(plotDT, aes(x = month, y = sumkWh/1000000, fill = Fuel_Code)) +
  geom_col() +
  facet_grid(. ~ year) +
  labs(caption = ggParams$figCaption, y = "Total GWh", x = "Month") +
  theme(legend.title=element_blank())
```

The next plot shows the mean of half-hourly values for each month and indicates that the Coal generation may be skewed, especially for June 1998 by a few very large values (ref the histograms above).
```{r mean plot}
ggplot(plotDT, aes(x = month, y = meankWh/1000000, fill = Fuel_Code)) +
  geom_col() +
  facet_grid(. ~ year) +
  labs(caption = ggParams$figCaption, y = "Mean GWh", x = "Month") +
  theme(legend.title=element_blank())
```

The next plot shows the standard deviation of the half-hourly generation data and suggests that coal has the highest absolute variation in June 1998 which may correspond to a particular spike and/or a period of very heavy use. Coal is less variable in 2017 perhaps due to the increased use of Gas.

```{r sd plot}
ggplot(plotDT, aes(x = month, y = sdkWh/1000000, fill = Fuel_Code)) +
  geom_col(position = "dodge") +
  facet_grid(year ~ .) +
  labs(caption = ggParams$figCaption, y = "SD GWh", x = "Month") +
  theme(legend.title=element_blank())
```

The final plot shows the coefficient of variation across the half-hourly values (mean/s.d). We take the CoV to indicate relative variability in generation load and the plots suggest that coal and wood tend to see greatest relative variability.

```{r cov plot}
plotDT <- plotDT[, cov := meankWh/sdkWh] # coefficient of variation https://en.wikipedia.org/wiki/Coefficient_of_variation
ggplot(plotDT, aes(x = month, y = cov, fill = Fuel_Code)) +
  geom_col(position = "dodge") +
  facet_grid(year ~ .) +
  labs(caption = ggParams$figCaption, y = "CoV GWh", x = "Month") +
  theme(legend.title=element_blank())
```

## Half hourly profiles by month

However the monthly plots do not tell us about the use of different generation sources by time of day which has clear implications for how peaks in demand are met.

```{r timeOfDay summary}
plotDT <- genDT[, 
                .(sumkWh = sum(kWh, na.rm = TRUE),
                  meankWh = mean(kWh, na.rm = TRUE),
                  mediankWh = median(kWh, na.rm = TRUE),
                  sdkWh = sd(kWh, na.rm = TRUE),
                  nObs = .N),
                keyby = .(rTime, month, year, Fuel_Code)]
```

To do this, the following plot replicates one of those found in [Staffel, 2018](https://www.sciencedirect.com/science/article/pii/S0301421516307017#f0025) for the UK to show how the different components of generation have changed over time. It shows the total half-hourly generation for each month summed over all days. Note that the half-hours are plotted at mid-points (00:15, 00:45, 01:15 etc...).

```{r sum profile plot by month }
# > Use the new data to draw a plot ----
ggplot2::ggplot(plotDT, 
       aes(x = rTime, y = sumkWh/1000000, fill = Fuel_Code)) +
  geom_col() +
  facet_grid(month ~ year) +
  labs(caption = ggParams$figCaption, y = "Sum GWh", x = "Half hour") +
  theme(legend.title=element_blank())

```

The next plot repeats this analysis but shows the mean, again suggesting that the values for coal are skewed by some extremely large values in December 1998 and by high generation values when used in 2017.

```{r mean profile plot by month }
# > Use the new data to draw a plot ----
ggplot2::ggplot(plotDT, 
       aes(x = rTime, y = meankWh/1000, fill = Fuel_Code)) +
  geom_col() +
  facet_grid(month ~ year) +
  labs(caption = ggParams$figCaption, y = "Mean MWh", x = "Half hour") +
  theme(legend.title=element_blank())

```


## Half hourly profiles by day of the month

The following plots show the profiles for each day of the month. Unfortunately due to the lack of wind generation in 1998 the colour scheme changes from 1998 to 2017. 

> To be fixed

Nevertheless the differences between the compositions of each half-hour can be seen.

```{r point profile plots by day of month, fig.width=8}
years <- c(1998,2017)
months <- c(6,12)

makePointProfilePlot <- function(dt, title){
  myPlot <- ggplot(dt, aes(x = rDateTime, y = kWh/1000, colour = Fuel_Code)) +
    geom_point() +
    labs(title = title, caption = ggParams$figCaption, y = "MWh", x = "Date") +
    theme(legend.title=element_blank(), legend.position="bottom")
    return(myPlot)
}

# Why doesn't this work??
# for(y in years){
#   for(m in months){
#     makeProfilePlot(genDT[year == y & month == m], paste0(m, "", y))
#   }
# }

makePointProfilePlot(genDT[year == 1998 & month == 6], "June 1998")
makePointProfilePlot(genDT[year == 1998 & month == 12], "December 1998")
makePointProfilePlot(genDT[year == 2017 & month == 6], "June 2017")
makePointProfilePlot(genDT[year == 2017 & month == 12], "December 2017")
```

The following plots repeat this but use stacked column plots to show the proportion of energy generation produced by each fuel.

```{r col profile plots by day of month, fig.width=8}
makeColProfilePlot <- function(dt, title){
  myPlot <- ggplot(dt, 
       aes(x = rDateTime, y = kWh/1000, fill = Fuel_Code)) +
  geom_col() +
  labs(title = title, caption = ggParams$figCaption, y = "MWh", x = "Date") +
  theme(legend.title=element_blank(), legend.position="bottom")
  return(myPlot)
}

# Why doesn't this work??
# for(y in years){
#   for(m in months){
#     makeProfilePlot(genDT[year == y & month == m], paste0(m, "", y))
#   }
# }

makeColProfilePlot(genDT[year == 1998 & month == 6], "June 1998")
makeColProfilePlot(genDT[year == 1998 & month == 12], "December 1998")
makeColProfilePlot(genDT[year == 2017 & month == 6], "June 2017")
makeColProfilePlot(genDT[year == 2017 & month == 12], "December 2017")
```


# Analysis: Trends 1998 - 2017

Using full dataset for each month & year. To Do.

# Discussion
here

# Conclusions
go here

# References
