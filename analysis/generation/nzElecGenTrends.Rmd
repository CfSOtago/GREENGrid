---
title: "NZ Electricity Generation Trends 1997-2018"
author: "Ben Anderson (b.anderson@soton.ac.uk `@dataknut`)"
date: 'Last run at: `r Sys.time()`'
output:
  html_document:
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    self_contained: no
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
options(knitr.table.format = 'markdown') # try to fix the tables issue (seems to be pushing html into latex)
```


```{r codeSetup, include=FALSE}
rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

library(nzGREENGrid)

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "dplyr", # data munching
             "ggplot2", # for fancy graphs
             "readr", # writing to files
             "skimr", # for skim
             "knitr" # for kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# run gg set up
nzGREENGrid::setup()

# Local paramaters
local <- 0 # set to 1 for local file storage (see below)

if(local){ # set data storage location
  lDataLoc <- path.expand("~/Data/NZGreenGrid/safe/ea/")
} else {
  lDataLoc <- path.expand("/Volumes/hum-csafe/Research Projects/GREEN Grid/_RAW DATA/EA_Generation_Data/")
}
ggParams$figCaption <- paste0("Source: EA wholesale generation data",
                              "\nhttps://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/")

```

If you wish to use any of the material from this report please cite as:

 * Anderson, B. (`r 1900 + as.POSIXlt(Sys.Date())$year`) _NZ Electricity Generation History_, `r ggParams$pubLoc`

This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

\newpage

# About

## Circulation

```{r generic circulation, child=ggParams$circulationGenericRmd}
```
 
## Purpose

This report is intended to: 

 * load and test NZ electricity generation data from https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/ from 1998 to 2017.

## Requirements:

 * pre-downloaded NZ wholesale generation datasets

## History

```{r generic history, child=ggParams$historyGenericRmd}
```
 
Specific history of this code: 
 * https://git.soton.ac.uk/ba1e12/nzGREENGrid/commits/master/analysis/generation/nzGenerationHistory.Rmd

## Support

```{r genric support, child=ggParams$supportGenericRmd}
```
 

# Introduction

Inspired by Steffel ([2018](https://www.sciencedirect.com/science/article/pii/S0301421516307017)) which analyses trends in the type and timing of generation in the UK over the same time period. Intended to build on Kahn et al's 2018 CO2 [intensity of peak demand](https://www.sciencedirect.com/science/article/pii/S0959652618306474?via%3Dihub) paper - how have thngs changed over time?

Uses https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/ from 1998 to 2017.

Data is kWh - so energy not power.

# Load data

Load the generation data from file. These have been pre-downloaded but could be pulled on the fly to be refreshed for other dates...

```{r load the generation data}
filesToDateDT <- data.table::as.data.table(list.files(lDataLoc, "long.csv.gz")) # get list of files already downloaded & converted to long form

# for our purposes here we will just use Jun & Dec in 1998 & 2017
filesToDateDT <- filesToDateDT[, c("year","month", "stub") := tstrsplit(V1, "_")]
filesToLoadDT <- filesToDateDT[(year == 1998 | year == 2017) & (month == "06" | month == "12"), V1]


genDT <- as.data.table(do.call(rbind,
                                  lapply(filesToLoadDT,
                                         function(f)
                                           readr::read_csv(paste0(lDataLoc,f),
                                                    progress = FALSE,
                                                    col_types = cols()
                                           ) # decodes .gz on the fly, requires readr, use the NULL col_types to suppress feedback
                                         # https://blog.rstudio.org/2016/08/05/readr-1-0-0/
                                  )
                               )
                       )

print("Files loaded")
print(paste0("Loaded ", tidyNum(nrow(genDT)), " rows of data"))
```

The following table sumamrises the data.

```{r summarise final data table}
t <- skimr::skim(genDT)
# note the chunk names needs to be unique
skimr::kable(t, caption = "Summary table")
```

Notice that there are missing (NA) values in the kWh column. These are caused by periods 49 and 50 being missing:

> "The data is presented by trading period, TP1, TP2, ... TP48. Trading period 1 starts at midnight, trading period 2 starts at 12:30am, trading period 3 starts at 1:00am, etc. Users of this data should be aware of daylight saving in New Zealand. On the day daylight saving commences there are only 46 trading periods and on the day it ends, there are 50." (https://www.emi.ea.govt.nz/Wholesale/Datasets/Generation/Generation_MD/)

Daylight saving begins/ends in October and March so we carefully avoid this problem by using June and December. However these TP are still present as NA in the data as the following plot of NA observations (only) by Fuel Type and month shows.

```{r explore NA, fig.cap="Plot showing presence of NA observations by time period and Fuel Type"}
genDT <- genDT[, kWhisNA := ifelse(is.na(kWh), "NA", "Not NA")] # label NAs

naPlotDT <- genDT[, .(nObs = .N), keyby = .(year, month, Time_Period, Fuel_Code, kWhisNA)] # table them for plot

# plot the NAs by Time_Period to look for patterns
ggplot(naPlotDT[kWhisNA == "NA"], aes(x = month, y = Time_Period, fill = nObs)) + 
  geom_tile() +
  facet_grid(year  ~ Fuel_Code) +
      labs(x = "Month",
         caption = ggParams$figCaption
    )
```

# Analysis: Generation profiles

## Half hourly profiles by month

This plot replicates one of those found in [Staffel, 2018](https://www.sciencedirect.com/science/article/pii/S0301421516307017#f0025) for the UK to show how the different components of generation have changed over time.

```{r profile plot by month }
# See how we turned off printing the code into the report

# create an aggregated tabe summing generation by fuel, date and time period. This is what data.table is really good at
plotDT <- genDT[, 
                       .(totalkWh = sum(kWh),
                         nObs = .N),
                       keyby = .(rTime, month, year, Fuel_Code)]

# > Use the new data to draw a chart of all generation in the data ----
ggplot(plotDT, 
       aes(x = rTime, y = totalkWh/1000000, fill = Fuel_Code)) +
  geom_col() +
  facet_grid(month ~ year) +
  labs(caption = ggParams$figCaption, y = "GWh", x = "Half hour") +
  theme(legend.title=element_blank())

```


## Half hourly profiles by day of the month

This plot shows the profiles for each day of each month joined end to end.

> requires creation of true dateTime...

```{r profile plot by day of month }
# to do

```




# Discuss your results
here

# Conclusions
go here

# References
